{% extends 'base.html.twig' %}

{% block body %}

    <script>
        $(document).ready(function () {
            $("#project_search_form_keyActions").change(function(){

                var $project_search_form_actions = $('#project_search_form_actions');

                var keyActionId = $(this).val();
                if(keyActionId) {

                    var url = '{{ localizedPath("project_actions_list", {'keyActionId': '1234'}) }}';
                    url = url.replace("1234", keyActionId);

                    $.ajax({
                        type: 'get',
                        url: url,
                        success: function (data) {
                            $project_search_form_actions.empty();
                            $project_search_form_actions.html('<option>--</option>');
                            for (var i = 0, total = data.length; i < total; i++) {
                                $project_search_form_actions.append('<option value="' + data[i].id + '">' + data[i].name_en + '</option>');
                            }
                        }
                    });
                }
                else {
                    $project_search_form_actions.empty();
                    $project_search_form_actions.html('<option>--</option>');
                }
            })
        });
    </script>

    <section id="main">
        {{ form_start(form, {'method': 'get', 'action': path('default_route', {'locale': app.request.getLocale()}) }) }}
        {{ form_widget(form) }}
        <div>
            <input class="btn btn-primary" type="submit" value="{{ 'home.submit'|trans }}" />
        </div>
        {{ form_end(form) }}
    </section>

    <div class="container-fluid">
        <div class="col-xs-12 section-heading">
            <h2><b>{% trans %}Projects{% endtrans %}</b></h2>
        </div>
        <table id="example" class="table table-striped table-bordered table-hover" data-toggle="table">
            <thead>
            <tr class="table-header">
                <th class="sortable" data-field="project_id" data-sortable="true">{% trans %}Nr.{% endtrans %}</th>
                <th class="sortable">{% trans %}Name{% endtrans %}</th>
                <th class="sortable">{% trans %}Acronym{% endtrans %}</th>
                <th>{% trans %}Project number{% endtrans %}</th>
                <th>{% trans %}Programme{% endtrans %}</th>
                <th>{% trans %}Key Action{% endtrans %}</th>
                <th>{% trans %}Action{% endtrans %}</th>
                <th>{% trans %}Call{% endtrans %}</th>
                <th>{% trans %}Round{% endtrans %}</th>
                <th>{% trans %}On-going{% endtrans %}</th>
                {% if app.user %}
                    <th class="noExport">{% trans %}View{% endtrans %}</th>
                    <th class="noExport">{% trans %}Edit{% endtrans %}</th>
                {% endif %}
            </tr>
            </thead>

            <tbody>
            {% for key,value in results %}
                <tr>
                    <td> {{ value.id }} </td>
                    <td> {{ value.nameEn }} </td>
                    <td> {{ value.acronym }} </td>
                    <td> {{ value.projectNumber }} </td>
                    <td> {{ value.programmes ? value.programmes.name(app.request.locale) }} </td>
                    <td> {{ value.keyActions ? value.keyActions.name(app.request.locale) }} </td>
                    <td> {{ value.actions ? value.actions.name(app.request.locale) }} </td>
                    <td> {{ value.calls ? value.calls.name(app.request.locale) }} </td>
                    <td> {{ value.rounds ? value.rounds.name(app.request.locale) }} </td>
                    <td> {{ value.onGoing ? 'Yes' : 'No' }} </td>
                    {% if app.user %}
                        {% if value.keyActions.name(app.request.locale) == 'ka1' %}
                            <td> <a href="{{ localizedPath('project_view', {'projectId':value.id }) }}"> View </a> </td>
                            <td> <a href="{{ localizedPath('project_edit', {'projectId':value.id }) }}"> Edit </a> </td>
                        {% elseif value.keyActions.name(app.request.locale) == 'ka2' %}
                            <td> <a href="{{ localizedPath('project_ka2_view', {'projectId':value.id }) }}"> View </a> </td>
                            <td> <a href="{{ localizedPath('project_ka2_edit', {'projectId':value.id }) }}"> Edit </a> </td>
                        {% else %}
                            <td><span style="color: red"> Unsupported KA</span></td>
                            <td><span style="color: red"> Unsupported KA</span></td>
                        {% endif %}
                    {% endif %}
                </tr>
            {% endfor %}
            </tbody>

        </table>

    </div>
    <div>

        {#todo: move this code to separate js file and on document ready disable seaching for table example#}
        <script>
            var table = $('#example').DataTable({
                searching: false,
                dom: 'lBfrtip',
                buttons: [
                    {
                        extend: 'excel',
                        exportOptions: {columns: ':not(.noExport)'}
                    }
                ]
            });
        </script>

{% endblock %}